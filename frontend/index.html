<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>AI Chat</title>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                DEFAULT: "#6366F1",
                dark: "#4F46E5",
                light: "#E0E7FF",
              },
              surface: "#0F172A",
            },
          },
        },
      };
    </script>

    <style>
      * {
        box-sizing: border-box;
      }
      html {
        height: 100%;
        height: 100svh; /* Small viewport height - best for mobile */
        height: 100dvh; /* Dynamic viewport height - fallback */
        margin: 0;
        padding: 0;
        overflow: hidden;
        width: 100%;
      }
      body {
        height: 100%;
        height: 100svh; /* Small viewport height - best for mobile */
        height: 100dvh; /* Dynamic viewport height - fallback */
        height: calc(var(--vh, 1vh) * 100); /* JavaScript fallback for older browsers */
        margin: 0;
        padding: 0;
        overflow: hidden;
        width: 100%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 50%, #0f172a 100%);
      }
      /* Use CSS custom property for dynamic viewport height */
      :root {
        --vh: 1vh;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        /* Markdown/Prose styling */
.prose p {
  margin: 0.5em 0;
}
.prose p:first-child {
  margin-top: 0;
}
.prose p:last-child {
  margin-bottom: 0;
}
.prose h1,
.prose h2,
.prose h3 {
  margin: 1em 0 0.5em;
  font-weight: 600;
}
.prose h1 {
  font-size: 1.25em;
}
.prose h2 {
  font-size: 1.15em;
}
.prose h3 {
  font-size: 1.1em;
}
.prose ul,
.prose ol {
  margin: 0.5em 0;
  padding-left: 1.5em;
}
.prose code {
  background: #334155;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.9em;
}
.prose pre {
  background: #1e293b;
  color: #f1f5f9;
  padding: 1em;
  border-radius: 8px;
  overflow-x: auto;
  margin: 0.5em 0;
}
.prose pre code {
  background: transparent;
  padding: 0;
}
      }

      /* Simple custom scrollbar for chat area */
      .chat-scroll::-webkit-scrollbar {
        width: 4px;
      }
      .chat-scroll::-webkit-scrollbar-track {
        background: transparent;
      }
      .chat-scroll::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.4);
        border-radius: 9999px;
      }
      .chat-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.6);
      }

      /* Mobile touch improvements */
      @media (max-width: 640px) {
        button, textarea {
          -webkit-tap-highlight-color: transparent;
        }
        
        textarea {
          font-size: 16px !important; /* Prevents zoom on iOS */
        }
      }

      /* Smooth scrolling */
      .chat-scroll {
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
      }

      /* Floating bubble container */
      .chat-bubble {
        width: 95%;
        max-width: 420px;
        height: 85vh;
        max-height: 750px;
        min-height: 600px;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 32px;
        box-shadow: 
          0 25px 80px rgba(0, 0, 0, 0.6),
          0 0 0 1px rgba(255, 255, 255, 0.08),
          0 0 100px rgba(99, 102, 241, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        backdrop-filter: blur(20px);
        animation: floatIn 0.5s ease-out;
      }

      @keyframes floatIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Subtle glow effect */
      .chat-bubble::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.2));
        border-radius: 32px;
        z-index: -1;
        opacity: 0.5;
        filter: blur(20px);
      }

      @media (max-width: 640px) {
        .chat-bubble {
          width: 100%;
          height: 100vh;
          height: 100dvh;
          max-height: none;
          min-height: 100vh;
          min-height: 100dvh;
          border-radius: 0;
          box-shadow: none;
        }
        
        .chat-bubble::before {
          display: none;
        }
      }

      /* Message animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-wrapper {
        animation: slideIn 0.3s ease-out;
      }
    </style>
  </head>

  <body class="text-slate-100 overflow-hidden">
    <div
      class="chat-bubble bg-slate-900 flex flex-col overflow-hidden"
    >
      <!-- Header -->
      <header
        class="px-5 py-4 border-b border-slate-800/50 flex items-center justify-center bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-sm shrink-0"
      >
        <div class="flex items-center gap-2.5">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center shadow-lg shadow-primary/30">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="w-4 h-4 text-white">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h1 class="text-lg font-semibold tracking-tight text-slate-100 bg-gradient-to-r from-slate-100 to-slate-300 bg-clip-text text-transparent">
            Home Made AI
          </h1>
        </div>
      </header>

      <!-- Chat Area -->
      <main
        id="chat-container"
        class="flex-1 overflow-y-auto chat-scroll px-4 py-4 space-y-4 text-[15px] min-h-0"
      >
        <!-- Initial assistant message -->
        <div class="flex items-start gap-3 message-wrapper">
          <div
            class="mt-0.5 w-8 h-8 rounded-full bg-gradient-to-br from-primary/20 to-purple-600/20 border border-primary/30 flex items-center justify-center text-xs font-semibold text-primary-light shrink-0 shadow-sm"
          >
            AI
          </div>
          <div
            class="max-w-[85%] rounded-2xl rounded-tl-sm bg-slate-800/90 backdrop-blur-sm px-4 py-3 shadow-sm border border-slate-700/50"
          >
            <p class="leading-relaxed text-slate-100">
              Hi! I'm your AI assistant. Ask me anything, and I'll do my best to
              help.
            </p>
          </div>
        </div>
      </main>

      <!-- Typing indicator / loader -->
      <div
        id="typing-indicator"
        class="px-4 pb-3 text-sm text-slate-400 hidden shrink-0"
      >
        <div class="flex items-center gap-2.5">
          <div class="flex items-center gap-1">
            <span class="relative flex h-2 w-2">
              <span
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"
              ></span>
              <span
                class="relative inline-flex rounded-full h-2 w-2 bg-primary"
              ></span>
            </span>
          </div>
          <span class="font-medium">AI is thinking...</span>
        </div>
      </div>

      <!-- Input Area -->
      <footer
        class="px-4 pt-4 pb-4 border-t border-slate-800/50 bg-gradient-to-t from-slate-900 to-slate-900/95 backdrop-blur-sm shrink-0"
        style="padding-bottom: max(1rem, env(safe-area-inset-bottom));"
      >
        <form id="chat-form" class="flex items-end gap-3">
          <div
            class="flex-1 rounded-2xl bg-slate-800/90 backdrop-blur-sm border border-slate-700/50 focus-within:border-primary/60 focus-within:ring-2 focus-within:ring-primary/20 transition-all shadow-sm"
          >
            <textarea
              id="user-input"
              rows="1"
              placeholder="Message HomeMade AI..."
              class="w-full resize-none bg-transparent border-0 outline-none text-[15px] px-4 py-3 placeholder:text-slate-500 text-slate-100 leading-relaxed"
            ></textarea>
          </div>
          <button
            id="send-button"
            type="submit"
            class="shrink-0 inline-flex items-center justify-center rounded-2xl bg-gradient-to-br from-primary to-primary-dark hover:from-primary-dark hover:to-primary disabled:from-slate-700 disabled:to-slate-700 disabled:text-slate-400 text-white transition-all w-12 h-12 shadow-lg shadow-primary/30 active:scale-95 active:shadow-md"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              class="w-5 h-5"
            >
              <path
                d="M22 2L11 13"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M22 2l-7 20-4-9-9-4 20-7z"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </form>
      </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      // Fix viewport height for mobile browsers
      function setViewportHeight() {
        const actualHeight = window.innerHeight;
        const vh = actualHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        
        // Also set body and html height directly to ensure it works
        document.body.style.height = `${actualHeight}px`;
        document.documentElement.style.height = `${actualHeight}px`;
        
        // Prevent any overflow
        document.body.style.maxHeight = `${actualHeight}px`;
        document.documentElement.style.maxHeight = `${actualHeight}px`;
      }
      
      // Set initial viewport height immediately (before DOM is ready)
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setViewportHeight);
      } else {
        setViewportHeight();
      }
      
      // Also set after a short delay to catch any initial render issues
      setTimeout(setViewportHeight, 50);
      setTimeout(setViewportHeight, 200);
      
      // Update on resize and orientation change
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(setViewportHeight, 50);
      });
      
      window.addEventListener('orientationchange', () => {
        setTimeout(setViewportHeight, 150);
      });
      
      // Handle visual viewport changes (mobile browser address bar)
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
          setViewportHeight();
        });
        window.visualViewport.addEventListener('scroll', () => {
          setViewportHeight();
        });
      }
      
      // Additional mobile-specific handling
      let lastHeight = window.innerHeight;
      const checkHeight = () => {
        const currentHeight = window.innerHeight;
        if (Math.abs(currentHeight - lastHeight) > 10) {
          setViewportHeight();
          lastHeight = currentHeight;
        }
      };
      
      // Check height periodically on mobile
      setInterval(checkHeight, 200);

      const API_URL = "https://homemadeai.onrender.com/chat"; // adjust if your backend runs elsewhere

      const chatContainer = document.getElementById("chat-container");
      const chatForm = document.getElementById("chat-form");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const typingIndicator = document.getElementById("typing-indicator");

      function appendMessage({ from, text }) {
        const isUser = from === "user";

        const wrapper = document.createElement("div");
        wrapper.className = `flex items-start gap-3 message-wrapper ${
          isUser ? "justify-end" : ""
        }`;

        const avatar = document.createElement("div");
        avatar.className =
          "mt-0.5 w-8 h-8 rounded-full flex items-center justify-center text-xs font-semibold shrink-0 shadow-sm";
        avatar.textContent = isUser ? "You" : "AI";
        if (isUser) {
          avatar.classList.add(
            "bg-gradient-to-br from-primary/20 to-purple-600/20",
            "border",
            "border-primary/30",
            "text-primary-light",
            "order-2"
          );
        } else {
          avatar.classList.add(
            "bg-gradient-to-br from-primary/20 to-purple-600/20",
            "border",
            "border-primary/30",
            "text-primary-light"
          );
        }

        const bubble = document.createElement("div");
        bubble.className =
          "max-w-[85%] rounded-2xl px-4 py-3 text-[15px] leading-relaxed prose shadow-sm";

        if (isUser) {
          bubble.classList.add(
            "rounded-tr-sm",
            "bg-gradient-to-br from-primary to-primary-dark",
            "text-white",
            "border",
            "border-primary/30"
          );
        } else {
          bubble.classList.add(
            "rounded-tl-sm",
            "bg-slate-800/90",
            "backdrop-blur-sm",
            "text-slate-100",
            "border",
            "border-slate-700/50"
          );
        }

        // Basic text handling (no markdown parsing, but keeps line breaks)
        //bubble.textContent = text;

        if (isUser) {
          wrapper.appendChild(bubble);
          wrapper.appendChild(avatar);
          bubble.textContent = text;
        } else {
          wrapper.appendChild(avatar);
          wrapper.appendChild(bubble);
          bubble.innerHTML = marked.parse(text);
        }

        chatContainer.appendChild(wrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function setLoading(isLoading) {
        if (isLoading) {
          typingIndicator.classList.remove("hidden");
          sendButton.disabled = true;
          userInput.disabled = true;
        } else {
          typingIndicator.classList.add("hidden");
          sendButton.disabled = false;
          userInput.disabled = false;
          userInput.focus();
        }
      }

      async function sendMessage(message) {
        appendMessage({ from: "user", text: message });
        setLoading(true);

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message }),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              `Server error: ${response.status}. ${errorData.details || errorData.error || ""}`
            );
          }

          const data = await response.json();
          const reply = data.reply || "No response from AI.";

          appendMessage({ from: "assistant", text: reply });
        } catch (error) {
          console.error(error);
          const errorMessage = error.message || "Unknown error";
          appendMessage({
            from: "assistant",
            text:
              "Sorry, there was an error: " + errorMessage +
              "\n\nMake sure:\n1. Backend is running on http://localhost:3001\n2. GROQ_API_KEY is set in backend/.env\n3. Dependencies are installed (npm install in backend folder)",
          });
        } finally {
          setLoading(false);
        }
      }

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = userInput.value.trim();
        if (!text) return;
        userInput.value = "";
        userInput.style.height = "auto";
        sendMessage(text);
      });

      // Auto-grow textarea
      userInput.addEventListener("input", () => {
        userInput.style.height = "auto";
        userInput.style.height = Math.min(userInput.scrollHeight, 120) + "px";
      });

      // Send on Enter (but allow Shift+Enter for newline)
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(new Event("submit"));
        }
      });
    </script>
  </body>
</html>


