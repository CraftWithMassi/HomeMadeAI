<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    <meta name="description" content="HomeMade AI - Your personal AI assistant" />
    <meta name="theme-color" content="#0F172A" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>HomeMade AI Chat</title>

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                DEFAULT: "#6366F1",
                dark: "#4F46E5",
              },
            },
          },
        },
      };
    </script>

    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        height: 100%;
        height: 100vh;
        height: 100dvh;
        margin: 0;
        padding: 0;
        overflow: hidden;
        width: 100%;
        position: fixed;
        overscroll-behavior: none;
      }

      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: #0F172A;
        display: flex;
        flex-direction: column;
      }

      /* Markdown styling */
      .prose p {
        margin: 0.75rem 0;
      }
      .prose p:first-child {
        margin-top: 0;
      }
      .prose p:last-child {
        margin-bottom: 0;
      }
      .prose h1,
      .prose h2,
      .prose h3 {
        margin: 1rem 0 0.5rem;
        font-weight: 600;
      }
      .prose h1 {
        font-size: 1.25rem;
      }
      .prose h2 {
        font-size: 1.125rem;
      }
      .prose h3 {
        font-size: 1.0625rem;
      }
      .prose ul,
      .prose ol {
        margin: 0.75rem 0;
        padding-left: 1.5rem;
      }
      .prose li {
        margin: 0.25rem 0;
      }
      .prose code {
        background: #334155;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-family: 'Courier New', monospace;
      }
      .prose pre {
        background: #1e293b;
        color: #f1f5f9;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 0.75rem 0;
      }
      .prose pre code {
        background: transparent;
        padding: 0;
      }
      .prose a {
        color: #818cf8;
        text-decoration: underline;
      }
      .prose a:hover {
        color: #a5b4fc;
      }

      /* Custom scrollbar */
      .chat-scroll::-webkit-scrollbar {
        width: 6px;
      }
      .chat-scroll::-webkit-scrollbar-track {
        background: transparent;
      }
      .chat-scroll::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.2);
        border-radius: 3px;
      }
      .chat-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.4);
      }

      /* Smooth scrolling */
      .chat-scroll {
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
      }

      /* Main container - fullscreen */
      .chat-container {
        width: 100%;
        height: 100%;
        height: 100vh;
        height: 100dvh;
        background: #0F172A;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }

      /* Message animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(0.5rem);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-wrapper {
        animation: slideIn 0.3s ease-out;
      }

      /* Loading dots animation */
      @keyframes pulse {
        0%, 100% {
          opacity: 0.4;
        }
        50% {
          opacity: 1;
        }
      }

      .loading-dot:nth-child(1) {
        animation: pulse 1.4s infinite;
      }
      .loading-dot:nth-child(2) {
        animation: pulse 1.4s infinite 0.2s;
      }
      .loading-dot:nth-child(3) {
        animation: pulse 1.4s infinite 0.4s;
      }

      /* Disable button state */
      button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }

      /* Copy button */
      .copy-button {
        opacity: 0;
        transition: opacity 0.2s;
      }
      .message-wrapper:hover .copy-button {
        opacity: 1;
      }

      /* Focus visible for accessibility */
      *:focus-visible {
        outline: 2px solid #6366F1;
        outline-offset: 2px;
      }

      /* User message bubble - dynamic width */
      .user-bubble {
        display: inline-block;
        max-width: 85%;
        word-wrap: break-word;
      }

      /* AI message container */
      .ai-message-container {
        max-width: 85%;
      }

      /* Prevent iOS zoom on input focus */
      input[type="text"],
      textarea {
        font-size: 16px;
      }

      /* Safe area handling for iPhone */
      .header-safe {
        padding-top: max(1rem, env(safe-area-inset-top));
      }

      .footer-safe {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    </style>
  </head>

  <body class="text-slate-100">
    <div class="chat-container">
      <!-- Header -->
      <header
        class="px-4 py-3 header-safe border-b border-slate-800 flex items-center justify-between bg-slate-900/95 backdrop-blur-sm shrink-0"
        role="banner"
      >
        <div class="flex items-center gap-2.5">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="w-4 h-4 text-white">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h1 class="text-base font-semibold text-slate-100">
            HomeMade AI
          </h1>
        </div>
        <button
          id="clear-chat"
          type="button"
          class="p-2 rounded-lg hover:bg-slate-800 transition-colors active:bg-slate-700"
          aria-label="Clear chat history"
          title="Clear chat"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </header>

      <!-- Chat Area -->
      <main
        id="chat-container"
        class="flex-1 overflow-y-auto chat-scroll px-4 py-4 space-y-4 min-h-0"
        role="main"
        aria-live="polite"
        aria-label="Chat messages"
      >
        <!-- Initial assistant message -->
        <div class="flex items-start gap-2.5 message-wrapper" role="article">
          <div
            class="mt-1 w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-xs font-medium text-slate-300 shrink-0"
            aria-label="AI assistant"
          >
            AI
          </div>
          <div class="flex-1 ai-message-container">
            <div class="rounded-2xl rounded-tl-md bg-slate-800/70 px-3.5 py-2.5 border border-slate-700/50">
              <p class="leading-relaxed text-[15px] text-slate-200">
                Hi! I'm your AI assistant. Ask me anything, and I'll do my best to help.
              </p>
            </div>
          </div>
        </div>
      </main>

      <!-- Typing indicator -->
      <div
        id="typing-indicator"
        class="px-4 pb-3 text-sm text-slate-400 hidden shrink-0"
        role="status"
        aria-live="polite"
      >
        <div class="flex items-center gap-2.5">
          <div
            class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-xs font-medium text-slate-300 shrink-0"
            aria-hidden="true"
          >
            AI
          </div>
          <div class="flex items-center gap-2">
            <div class="flex gap-1">
              <span class="w-2 h-2 rounded-full bg-slate-500 loading-dot"></span>
              <span class="w-2 h-2 rounded-full bg-slate-500 loading-dot"></span>
              <span class="w-2 h-2 rounded-full bg-slate-500 loading-dot"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Error message -->
      <div
        id="error-message"
        class="mx-4 mb-3 px-4 py-3 rounded-xl bg-red-950/50 border border-red-800/50 text-red-200 text-sm hidden shrink-0"
        role="alert"
      >
        <div class="flex items-start gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 shrink-0 mt-0.5">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <div class="flex-1">
            <p id="error-text" class="font-medium"></p>
            <button
              id="retry-button"
              class="mt-2 text-red-300 hover:text-red-100 underline text-sm font-medium"
            >
              Try again
            </button>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <footer
        class="px-4 pt-3 pb-4 footer-safe border-t border-slate-800 bg-slate-900/95 backdrop-blur-sm shrink-0"
        role="contentinfo"
      >
        <form id="chat-form" class="flex items-end gap-2.5">
          <div
            class="flex-1 rounded-3xl bg-slate-800 border border-slate-700 focus-within:border-slate-600 transition-colors"
          >
            <textarea
              id="user-input"
              rows="1"
              placeholder="Message..."
              class="w-full resize-none bg-transparent border-0 outline-none text-base px-4 py-3 placeholder:text-slate-500 text-slate-100 leading-relaxed max-h-32 overflow-y-auto"
              aria-label="Message input"
              maxlength="2000"
            ></textarea>
          </div>
          <button
            id="send-button"
            type="submit"
            class="shrink-0 inline-flex items-center justify-center rounded-full bg-slate-200 hover:bg-white disabled:bg-slate-700 disabled:text-slate-500 text-slate-900 transition-colors w-11 h-11 active:scale-95"
            aria-label="Send message"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-5 h-5"
              aria-hidden="true"
            >
              <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
            </svg>
          </button>
        </form>
      </footer>
    </div>

    <!-- Lightweight markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
      // Configuration
      const CONFIG = {
        API_URL: "https://homemadeai.onrender.com/chat",
        MAX_RETRIES: 2,
        RETRY_DELAY: 1000,
        REQUEST_TIMEOUT: 30000,
      };

      // DOM elements
      const elements = {
        chatContainer: document.getElementById("chat-container"),
        chatForm: document.getElementById("chat-form"),
        userInput: document.getElementById("user-input"),
        sendButton: document.getElementById("send-button"),
        typingIndicator: document.getElementById("typing-indicator"),
        errorMessage: document.getElementById("error-message"),
        errorText: document.getElementById("error-text"),
        retryButton: document.getElementById("retry-button"),
        clearChat: document.getElementById("clear-chat"),
      };

      // State management
      let lastMessage = "";
      let isProcessing = false;
      let conversationHistory = [];

      // Configure marked for security
      marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false,
      });

      // Sanitize HTML to prevent XSS
      function sanitizeHTML(html) {
        const div = document.createElement('div');
        div.textContent = html;
        return div.innerHTML;
      }

      // Render markdown safely
      function renderMarkdown(text) {
        try {
          const rawHtml = marked.parse(text);
          return rawHtml;
        } catch (error) {
          console.error('Markdown parsing error:', error);
          return sanitizeHTML(text);
        }
      }

      // Create message element
      function createMessageElement({ from, text, timestamp }) {
        const isUser = from === "user";
        const wrapper = document.createElement("div");
        wrapper.className = `flex items-start gap-2.5 message-wrapper ${isUser ? "justify-end" : ""}`;
        wrapper.setAttribute("role", "article");

        const avatar = document.createElement("div");
        avatar.className = "mt-1 w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium shrink-0";
        avatar.textContent = isUser ? "You" : "AI";
        avatar.setAttribute("aria-label", isUser ? "You" : "AI assistant");

        if (isUser) {
          avatar.classList.add(
            "bg-slate-700",
            "text-slate-300",
            "order-2"
          );
        } else {
          avatar.classList.add(
            "bg-slate-800",
            "text-slate-300"
          );
        }

        const bubble = document.createElement("div");

        if (isUser) {
          // User message - dynamic width
          bubble.className = "user-bubble rounded-3xl rounded-tr-md bg-primary px-3.5 py-2.5 text-[15px] leading-relaxed text-white";
          bubble.textContent = text;
          
          wrapper.appendChild(bubble);
          wrapper.appendChild(avatar);
        } else {
          // AI message - with container
          const contentWrapper = document.createElement("div");
          contentWrapper.className = "flex-1 ai-message-container";

          bubble.className = "rounded-2xl rounded-tl-md bg-slate-800/70 px-3.5 py-2.5 text-[15px] leading-relaxed text-slate-200 border border-slate-700/50 prose";
          bubble.innerHTML = renderMarkdown(text);

          // Add copy button for AI messages
          const copyButton = document.createElement("button");
          copyButton.className = "mt-2 text-xs text-slate-500 hover:text-slate-300 flex items-center gap-1 copy-button transition-all";
          copyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-3.5 h-3.5">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
            </svg>
            Copy
          `;
          copyButton.setAttribute("aria-label", "Copy message");
          copyButton.onclick = () => copyToClipboard(text, copyButton);

          contentWrapper.appendChild(bubble);
          contentWrapper.appendChild(copyButton);

          wrapper.appendChild(avatar);
          wrapper.appendChild(contentWrapper);
        }

        return wrapper;
      }

      // Append message to chat
      function appendMessage(messageData) {
        const messageElement = createMessageElement(messageData);
        elements.chatContainer.appendChild(messageElement);
        scrollToBottom();
        
        // Store in history
        conversationHistory.push(messageData);
      }

      // Scroll to bottom
      function scrollToBottom() {
        requestAnimationFrame(() => {
          elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        });
      }

      // Copy to clipboard
      async function copyToClipboard(text, button) {
        try {
          await navigator.clipboard.writeText(text);
          const originalHTML = button.innerHTML;
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-3.5 h-3.5">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Copied!
          `;
          button.classList.add('text-green-400');
          setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('text-green-400');
          }, 2000);
        } catch (error) {
          console.error('Failed to copy:', error);
        }
      }

      // Set loading state
      function setLoading(isLoading) {
        isProcessing = isLoading;
        
        if (isLoading) {
          elements.typingIndicator.classList.remove("hidden");
          elements.sendButton.disabled = true;
          elements.userInput.disabled = true;
          hideError();
        } else {
          elements.typingIndicator.classList.add("hidden");
          elements.sendButton.disabled = false;
          elements.userInput.disabled = false;
          elements.userInput.focus();
        }
      }

      // Show error
      function showError(message) {
        elements.errorText.textContent = message;
        elements.errorMessage.classList.remove("hidden");
        scrollToBottom();
      }

      // Hide error
      function hideError() {
        elements.errorMessage.classList.add("hidden");
      }

      // Fetch with timeout
      async function fetchWithTimeout(url, options, timeout = CONFIG.REQUEST_TIMEOUT) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
          const response = await fetch(url, {
            ...options,
            signal: controller.signal,
          });
          clearTimeout(timeoutId);
          return response;
        } catch (error) {
          clearTimeout(timeoutId);
          throw error;
        }
      }

      // Send message to API
      async function sendMessage(message, retryCount = 0) {
        if (!message.trim()) return;

        appendMessage({ 
          from: "user", 
          text: message,
          timestamp: new Date().toISOString()
        });
        setLoading(true);

        try {
          const response = await fetchWithTimeout(
            CONFIG.API_URL,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message }),
            }
          );

          if (!response.ok) {
            let errorMessage = `Server error (${response.status})`;
            try {
              const errorData = await response.json();
              errorMessage = errorData.error || errorData.details || errorMessage;
            } catch (e) {
              // Could not parse error JSON
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();
          const reply = data.reply || "No response from AI.";

          appendMessage({ 
            from: "assistant", 
            text: reply,
            timestamp: new Date().toISOString()
          });
          
        } catch (error) {
          console.error('Send message error:', error);
          
          let errorMessage = "Unable to connect to AI service. ";
          
          if (error.name === 'AbortError') {
            errorMessage = "Request timed out. Please try again.";
          } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            errorMessage = "Network error. Check your connection and try again.";
          } else if (error.message) {
            errorMessage += error.message;
          }

          // Retry logic
          if (retryCount < CONFIG.MAX_RETRIES && !error.name === 'AbortError') {
            showError(`${errorMessage} Retrying... (${retryCount + 1}/${CONFIG.MAX_RETRIES})`);
            await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
            return sendMessage(message, retryCount + 1);
          }

          showError(errorMessage);
          lastMessage = message;
        } finally {
          setLoading(false);
        }
      }

      // Handle form submission
      elements.chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (isProcessing) return;
        
        const text = elements.userInput.value.trim();
        if (!text) return;
        
        elements.userInput.value = "";
        elements.userInput.style.height = "auto";
        sendMessage(text);
      });

      // Retry last message
      elements.retryButton.addEventListener("click", () => {
        if (lastMessage) {
          sendMessage(lastMessage);
        }
      });

      // Clear chat
      elements.clearChat.addEventListener("click", () => {
        if (confirm("Are you sure you want to clear the chat history?")) {
          const messages = elements.chatContainer.querySelectorAll('.message-wrapper');
          messages.forEach((msg, index) => {
            if (index > 0) msg.remove();
          });
          conversationHistory = [];
          hideError();
          elements.userInput.focus();
        }
      });

      // Auto-grow textarea
      elements.userInput.addEventListener("input", () => {
        elements.userInput.style.height = "auto";
        const newHeight = Math.min(elements.userInput.scrollHeight, 128);
        elements.userInput.style.height = newHeight + "px";
      });

      // Send on Enter (Shift+Enter for newline)
      elements.userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          elements.chatForm.dispatchEvent(new Event("submit"));
        }
      });

      // Focus input on load
      window.addEventListener('load', () => {
        elements.userInput.focus();
      });

      // Handle visibility change
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && !isProcessing) {
          elements.userInput.focus();
        }
      });

      // Prevent pull-to-refresh on iOS
      let startY = 0;
      elements.chatContainer.addEventListener('touchstart', (e) => {
        startY = e.touches[0].pageY;
      }, { passive: true });

      elements.chatContainer.addEventListener('touchmove', (e) => {
        const y = e.touches[0].pageY;
        if (elements.chatContainer.scrollTop === 0 && y > startY) {
          e.preventDefault();
        }
      }, { passive: false });
    </script>
  </body>
</html>